# Story 2.1: Activate Proactive Graph API Rate Limiting

## Status
Pass

## Story
**As a** developer,
**I want** to activate the existing Redis-based rate-limiting utility before making calls to the Microsoft Graph API,
**so that** the application proactively avoids `429 (Too Many Requests)` errors.

## Acceptance Criteria
1.  The `check_rate_limit` function from `concurrent_storage/redis_manager.py` is integrated into the Graph API calling logic in both `core/polling_service.py` and `core/webhook_service.py`.
2.  The rate limit's threshold and time window are configurable in `utils/config.py`.
3.  When the rate limit is exceeded, the task (poll or webhook process) pauses execution for a configurable duration before retrying, preventing request loss.
4.  Unit tests verify that the rate limiter correctly blocks requests when the configured threshold is surpassed.

## Tasks / Subtasks
- [x] **AC: 2** - Add rate limiting configuration to `utils/config.py`.
  - [x] Add `GRAPH_API_RATE_LIMIT_THRESHOLD` (e.g., 100).
  - [x] Add `GRAPH_API_RATE_LIMIT_WINDOW_SECONDS` (e.g., 60).
  - [x] Add `GRAPH_API_RATE_LIMIT_RETRY_DELAY_SECONDS` (e.g., 30).
- [x] **AC: 1** - Integrate `check_rate_limit` into `core/polling_service.py`.
  - [x] Before making a call to the Graph API, call `redis_manager.check_rate_limit`.
  - [x] If the rate limit is exceeded, pause execution for `GRAPH_API_RATE_LIMIT_RETRY_DELAY_SECONDS`.
- [x] **AC: 1** - Integrate `check_rate_limit` into `core/webhook_service.py`.
  - [x] Before making a call to the Graph API, call `redis_manager.check_rate_limit`.
  - [x] If the rate limit is exceeded, pause execution for `GRAPH_API_RATE_LIMIT_RETRY_DELAY_SECONDS`.
- [x] **AC: 4** - Create unit tests for the rate limiting logic.
  - [x] Create a test for `core/polling_service.py` that mocks `redis_manager.check_rate_limit` to return `False` and asserts that the service pauses and retries.
  - [x] Create a test for `core/webhook_service.py` that mocks `redis_manager.check_rate_limit` to return `False` and asserts that the service pauses and retries.

## Dev Notes
### API Specifications
- Microsoft Graph API: `https://graph.microsoft.com/v1.0` [Source: `architecture/6-external-apis.md#61-microsoft-graph-api`]

### Component Specifications
- Polling Service: Responsible for fetching emails from Microsoft Graph API. [Source: `architecture/5-components.md#511-polling-service`]
- Webhook Service: Responsible for receiving real-time notifications from Microsoft Graph and managing subscriptions. [Source: `architecture/5-components.md#512-webhook-service`]

### File Locations
- `concurrent_storage/redis_manager.py`
- `core/polling_service.py`
- `core/webhook_service.py`
- `utils/config.py`

### Technical Constraints
- All outbound HTTP calls to external APIs (Microsoft Graph, MS4) must use the `httpx` library and be wrapped with the defined retry and circuit breaker policies. [Source: `architecture/13-coding-standards.md#133-critical-rules`]
- All interactions with Redis must be encapsulated within and routed through `concurrent_storage/redis_manager.py`. [Source: `architecture/13-coding-standards.md#133-critical-rules`]

### Testing
- Test file location: `tests/` directory, mirroring the source code structure. [Source: `architecture/14-test-strategy-and-standards.md#142-test-types-and-organization`]
- Test standards: Follow the AAA (Arrange, Act, Assert) pattern for clarity. [Source: `architecture/14-test-strategy-and-standards.md#1421-unit-tests`]
- Testing frameworks and patterns to use: `pytest`. Use mocking libraries (`unittest.mock`). [Source: `architecture/14-test-strategy-and-standards.md#1421-unit-tests`]

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-11-02 | 1.0 | Initial draft of Story 2.1 | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
### Debug Log References
### Completion Notes List
### File List

## QA Results
- **Verification:** Confirmed that the rate limiting logic has been correctly implemented in both `core/polling_service.py` and `core/webhook_service.py`.
- **Test Execution:** All 27 tests passed, including the new unit tests for rate limiting. No regressions were found.
- **Gate Decision:** PASS
