# Story 1.3: Standardize All HTTP Communication on `httpx`

## Status
Pass

## Story
**As a** developer,
**I want** to replace all remaining instances of the `requests` library with `httpx` across the entire codebase,
**so that** the project's HTTP communication is fully standardized and consistent.

## Acceptance Criteria
1.  A project-wide search confirms no active usage of the `requests` library remains.
2.  The `requests` library is removed from the `requirements.txt` file.
3.  All functionality previously relying on `requests` (e.g., in `core/polling_service.py`, `core/webhook_service.py`) operates correctly using `httpx`.
4.  All relevant tests pass, confirming no regressions were introduced.

## Tasks / Subtasks
- [x] Conduct a project-wide search for `requests` library usage to identify all instances. (AC: 1)
- [x] Replace `requests` calls with `httpx` in `core/polling_service.py`. (AC: 3)
  - [x] Ensure proper `httpx.Client` instantiation and usage, considering shared instances and connection pooling.
  - [x] Update error handling and retry logic to align with `httpx` patterns.
- [x] Replace `requests` calls with `httpx` in `api/webhook_app.py`. (AC: 3)
  - [x] Ensure proper `httpx.Client` instantiation and usage, considering shared instances and connection pooling.
  - [x] Update error handling and retry logic to align with `httpx` patterns.
- [x] Replace `requests` calls with `httpx` in `core/ms4_batch_sender.py`. (AC: 3)
  - [x] Ensure proper `httpx.Client` instantiation and usage, considering shared instances and connection pooling.
  - [x] Update error handling and retry logic to align with `httpx` patterns.
- [x] Remove `requests` from `requirements.txt`. (AC: 2)
- [x] Update existing unit and integration tests to reflect `httpx` usage and ensure all tests pass. (AC: 4)
  - [x] Modify tests to mock `httpx` instead of `requests`.
  - [x] Verify that the tests still correctly assert the functionality.
- [x] Create new tests if necessary to cover any new `httpx` specific logic or edge cases. (AC: 4)

## Dev Notes
### Previous Story Insights
- The previous story (1.2) successfully refactored MS4 communication to use `httpx`. The developer correctly ensured the `httpx.Client` is properly closed on application shutdown.
- The use of a shared `httpx.Client` instance with connection pooling is good for performance.

### API Specifications
- Microsoft Graph API: `https://graph.microsoft.com/v1.0` [Source: `architecture/6-external-apis.md#61-microsoft-graph-api`]
- MS4 Persistence API: `http://localhost:8002/metadata` (current single-item endpoint). [Source: `architecture/6-external-apis.md#62-ms4-persistence-api`]

### Component Specifications
- Polling Service: Responsible for fetching emails from Microsoft Graph API. [Source: `architecture/5-components.md#511-polling-service`]
- Webhook Service: Responsible for receiving real-time notifications from Microsoft Graph and managing subscriptions. [Source: `architecture/5-components.md#512-webhook-service`]
- MS4 Batch Sender: Responsible for sending batched payloads to MS4 Persistence API. [Source: `architecture/5-components.md#516-ms4-batch-sender`]

### File Locations
- `requirements.txt`
- `core/polling_service.py`
- `api/webhook_app.py`
- `core/ms4_batch_sender.py`

### Technical Constraints
- All outbound HTTP calls to external APIs (Microsoft Graph, MS4) must use the `httpx` library and be wrapped with the defined retry and circuit breaker policies. [Source: `architecture/13-coding-standards.md#133-critical-rules`]
- `httpx` is the standardized client for all outbound HTTP requests, supporting async and connection pooling. [Source: `architecture/3-tech-stack.md#32-technology-stack-table`]

### Testing
- Test file location: `tests/` directory, mirroring the source code structure. [Source: `architecture/14-test-strategy-and-standards.md#142-test-types-and-organization`]
- Test standards: Follow the AAA (Arrange, Act, Assert) pattern for clarity. [Source: `architecture/14-test-strategy-and-standards.md#1421-unit-tests`]
- Testing frameworks and patterns to use: `pytest`. Use mocking libraries (`httpx.mock`, `responses`) or dedicated test doubles to simulate external API behavior for integration tests. [Source: `architecture/14-test-strategy-and-standards.md#1422-integration-tests`]
- Any specific testing requirements for this story: All relevant tests must pass, confirming no regressions were introduced.

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-11-01 | 1.0 | Initial draft of Story 1.3 | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
### Debug Log References
### Completion Notes List
- The `requests` library was not found in the codebase. All relevant files are already using `httpx`. The `requirements.txt` file also does not contain `requests`. The story appears to be outdated.
### File List

## QA Results
- **Verification:** Confirmed developer's findings. The `requests` library is not used in the codebase, and it is not listed in `requirements.txt`.
- **Test Execution:** All 25 tests passed after installing the missing `pytest-mock` dependency. The codebase is stable and no regressions were found.
- **Gate Decision:** PASS
