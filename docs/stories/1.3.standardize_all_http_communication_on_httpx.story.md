# Story 1.3: Standardize All HTTP Communication on httpx

## Status
Draft

## Story
**As a** developer,
**I want** to replace all remaining instances of the `requests` library with `httpx` across the entire codebase,
**so that** the project's HTTP communication is fully standardized and consistent.

## Acceptance Criteria
1. A project-wide search confirms no active usage of the `requests` library remains.
2. The `requests` library is removed from the `requirements.txt` file.
3. All functionality previously relying on `requests` (e.g., in `core/polling_service.py`, `core/webhook_service.py`) operates correctly using `httpx`.
4. All relevant tests pass, confirming no regressions were introduced.

## Tasks / Subtasks
- [ ] **Refactor `core/polling_service.py` to use `httpx` (AC: 1, 3)**
  - [ ] Replace `requests.get` with an `httpx.AsyncClient` for fetching emails from Microsoft Graph.
  - [ ] Ensure all API calls are asynchronous.
- [ ] **Refactor `core/webhook_service.py` to use `httpx` (AC: 1, 3)**
  - [ ] Replace `requests.post`, `requests.patch`, and `requests.delete` with an `httpx.AsyncClient` for managing webhook subscriptions.
  - [ ] Ensure all API calls are asynchronous.
- [ ] **Remove `requests` from `requirements.txt` (AC: 2)**
  - [ ] Delete the line for the `requests` library in the `requirements.txt` file.
- [ ] **Update and run tests (AC: 4)**
  - [ ] Modify any tests that mock `requests` to mock `httpx` instead.
  - [ ] Run all unit and integration tests to ensure no regressions.

## Dev Notes
### Previous Story Insights
Story 1.2 successfully refactored `core/unified_email_processor.py` to use `httpx`, establishing a pattern for using a shared `httpx.Client`. This story should extend that pattern to the rest of the application.

### API Specifications
- **Microsoft Graph API:** All interactions with the Graph API should be done via `httpx`. Endpoints to consider are:
  - `GET /me/mailFolders/{id}/messages`
  - `POST /subscriptions`
  - `PATCH /subscriptions/{id}`
  - `DELETE /subscriptions/{id}`
  - `POST /me/messages/{id}/markAsRead`
  (Source: `architecture/6-external-apis.md#61-microsoft-graph-api`)

### Component Specifications
- `core/polling_service.py`: Periodically fetches emails from MS Graph.
- `core/webhook_service.py`: Manages MS Graph webhook subscriptions.
(Source: `architecture/10-source-tree.md`)

### File Locations
- `core/polling_service.py`: To be refactored.
- `core/webhook_service.py`: To be refactored.
- `requirements.txt`: To be modified.
(Source: `architecture/10-source-tree.md`)

### Testing Requirements
- **Integration Tests:** Update tests to mock `httpx` instead of `requests`. Use `httpx.mock` or `responses` for mocking. (Source: `architecture/14-test-strategy-and-standards.md#1422-integration-tests`)
- **Test Location:** `tests/integration/`
- **Test Standards:** Follow the AAA (Arrange, Act, Assert) pattern. (Source: `architecture/14-test-strategy-and-standards.md#1421-unit-tests`)

### Technical Constraints
- All outbound HTTP calls to external APIs must use the `httpx` library. (Source: `architecture/13-coding-standards.md#133-critical-rules`)
- Prefer `asyncio` and the `async`/`await` syntax for all I/O-bound operations. (Source: `architecture/13-coding-standards.md#1341-python-specifics`)

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-11-01 | 1.0 | Initial draft of Story 1.3 | Bob (Scrum Master) |
