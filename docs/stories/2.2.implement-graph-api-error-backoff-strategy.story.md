# Story 2.2: Implement Graph API Error Backoff Strategy

## Status
Pass

## Story
**As a** developer,
**I want** to implement a retry mechanism that handles `429 (Too Many Requests)` and `503 (Service Unavailable)` responses from the Graph API,
**so that** the application can automatically recover from temporary API throttling or outages.

## Acceptance Criteria
1.  A decorator or wrapper is applied to all Graph API calls made with `httpx`.
2.  The wrapper catches `429` and `503` HTTP status codes.
3.  Upon catching a handled error, the wrapper reads the `Retry-After` header from the API response and waits for the specified duration.
4.  If no `Retry-After` header is present, it uses a default exponential backoff strategy.
5.  A configurable maximum number of retries is implemented to avoid infinite loops.
6.  Integration tests are created to simulate `429` and `503` responses and assert that the retry logic is executed correctly.

## Tasks / Subtasks
- [x] **AC: 1, 2, 3, 4, 5** - Design and implement a retry decorator/wrapper for `httpx` Graph API calls.
  - [x] Create a new module (e.g., `utils/api_retry.py`) to house the decorator.
  - [x] The decorator should accept configurable parameters for max retries, initial backoff, and backoff factor.
  - [x] Implement logic to catch `httpx.HTTPStatusError` for `429` and `503` status codes.
  - [x] Extract `Retry-After` header and use its value for delay if present.
  - [x] Implement exponential backoff with jitter if `Retry-After` is not present.
  - [x] Ensure a maximum number of retries is enforced.
  - [x] Apply the decorator to Graph API calls in `core/polling_service.py` and `core/webhook_service.py`.
- [x] **AC: 5** - Add configurable parameters for the retry mechanism to `utils/config.py`.
  - [x] `GRAPH_API_MAX_RETRIES` (e.g., 5)
  - [x] `GRAPH_API_INITIAL_BACKOFF_SECONDS` (e.g., 1)
  - [x] `GRAPH_API_BACKOFF_FACTOR` (e.g., 2)
- [x] **AC: 6** - Create integration tests for the retry mechanism.
  - [x] Use `httpx.mock` or a similar mocking library to simulate `429` and `503` responses from the Graph API.
  - [x] Assert that the retry logic correctly pauses and retries the API calls.
  - [x] Test scenarios with and without `Retry-After` headers.
  - [x] Test the maximum retry limit.

## Dev Notes
### Previous Story Insights
- Story 2.1 implemented proactive rate limiting using `redis_manager.py` to prevent `429` errors. This story focuses on reactive handling of `429` and `503` errors that might still occur.

### Data Models
- No new data models are directly introduced by this story. The `EmailMessage` data model will continue to be processed. [Source: `architecture/4-data-models.md#41-emailmessage`]

### API Specifications
- Microsoft Graph API: `https://graph.microsoft.com/v1.0`. This story specifically targets handling `429` and `503` responses from this API. [Source: `architecture/6-external-apis.md#61-microsoft-graph-api`]

### Component Specifications
- Polling Service: Will integrate the new retry mechanism for its Graph API calls. [Source: `architecture/5-components.md#511-polling-service`]
- Webhook Service: Will integrate the new retry mechanism for its Graph API calls (e.g., subscription management). [Source: `architecture/5-components.md#512-webhook-service`]

### File Locations
- New module for retry logic: `utils/api_retry.py` (proposed). [Source: `architecture/10-source-tree.md`]
- Configuration: `utils/config.py`. [Source: `architecture/10-source-tree.md`]
- Integration points: `core/polling_service.py`, `core/webhook_service.py`. [Source: `architecture/10-source-tree.md`]
- Tests: `tests/integration/test_api_retry.py` (proposed). [Source: `architecture/10-source-tree.md`]

### Technical Constraints
- All outbound HTTP calls to external APIs (Microsoft Graph, MS4) must use the `httpx` library and be wrapped with the defined retry and circuit breaker policies. [Source: `architecture/13-coding-standards.md#133-critical-rules`]
- An exponential backoff strategy with jitter will be implemented for transient errors (e.g., network issues, `429 Too Many Requests`, `503 Service Unavailable` from Microsoft Graph API or MS4). This will include configurable maximum retry attempts and total retry duration. [Source: `architecture/12-error-handling-strategy.md#1231-external-api-errors`]
- A circuit breaker pattern will be applied to calls to external services (Microsoft Graph API, MS4 Persistence API). [Source: `architecture/12-error-handling-strategy.md#1231-external-api-errors`]
- Explicit and configurable timeouts will be set for all outbound HTTP requests. [Source: `architecture/12-error-handling-strategy.md#1231-external-api-errors`]

### Testing
- Test file location: `tests/integration/` directory. [Source: `architecture/14-test-strategy-and-standards.md#1422-integration-tests`]
- Test standards: Follow the AAA (Arrange, Act, Assert) pattern for clarity. [Source: `architecture/14-test-strategy-and-standards.md#1421-unit-tests`]
- Testing frameworks and patterns to use: `pytest`. Use mocking libraries (`unittest.mock`, `httpx.mock` or similar) to simulate external API behavior. [Source: `architecture/14-test-strategy-and-standards.md#1421-unit-tests`, `architecture/14-test-strategy-and-standards.md#1422-integration-tests`]
- Integration tests are required to simulate `429` and `503` responses. [Source: Acceptance Criteria 6]

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-11-02 | 1.0 | Initial draft of Story 2.2 | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
### Debug Log References
### Completion Notes List
### File List
- `utils/api_retry.py` (created)
- `tests/integration/test_api_retry.py` (created)
- `utils/config.py` (modified)
- `core/polling_service.py` (modified)
- `core/webhook_service.py` (modified)

## QA Results
