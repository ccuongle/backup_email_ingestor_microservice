# Story 2.1: Activate Proactive Graph API Rate Limiting

## Status
Draft

## Story
**As a** developer,
**I want** to activate the existing Redis-based rate-limiting utility before making calls to the Microsoft Graph API,
**so that** the application proactively avoids `429 (Too Many Requests)` errors.

## Acceptance Criteria
1. The `check_rate_limit` function from `concurrent_storage/redis_manager.py` is integrated into the Graph API calling logic in both `core/polling_service.py` and `core/webhook_service.py`.
2. The rate limit's threshold and time window are configurable in `utils/config.py`.
3. When the rate limit is exceeded, the task (poll or webhook process) pauses execution for a configurable duration before retrying, preventing request loss.
4. Unit tests verify that the rate limiter correctly blocks requests when the configured threshold is surpassed.

## Tasks / Subtasks
- [ ] Integrate `check_rate_limit` in `core/polling_service.py` (AC: 1)
  - [ ] Import `check_rate_limit` from `concurrent_storage/redis_manager.py`.
  - [ ] Call `check_rate_limit` before making Graph API calls.
  - [ ] Implement pause/retry logic when rate limit is exceeded.
- [ ] Integrate `check_rate_limit` in `core/webhook_service.py` (AC: 1)
  - [ ] Import `check_rate_limit` from `concurrent_storage/redis_manager.py`.
  - [ ] Call `check_rate_limit` before making Graph API calls.
  - [ ] Implement pause/retry logic when rate limit is exceeded.
- [ ] Add rate limit configuration to `utils/config.py` (AC: 2)
  - [ ] Define `GRAPH_API_RATE_LIMIT_THRESHOLD`.
  - [ ] Define `GRAPH_API_RATE_LIMIT_WINDOW_SECONDS`.
  - [ ] Define `GRAPH_API_RATE_LIMIT_RETRY_DELAY_SECONDS`.
- [ ] Implement unit tests for rate limiter integration (AC: 4)
  - [ ] Create `tests/unit/test_rate_limiting.py`.
  - [ ] Mock `redis_manager.check_rate_limit`.
  - [ ] Test `polling_service` behavior when rate limit is hit.
  - [ ] Test `webhook_service` behavior when rate limit is hit.
  - [ ] Verify correct configuration loading from `utils/config.py`.

## Dev Notes
### Previous Story Insights
No previous story context.

### Data Models
- Rate Limiting Counters: `ratelimit:{api_key}:{timestamp_window}` key pattern in Redis (Source: `architecture/9-database-schema.md#96-rate-limiting-counters`).

### API Specifications
- Microsoft Graph API: Rate limits vary by endpoint and tenant. Proactive rate limiting is needed. (Source: `architecture/6-external-apis.md#61-microsoft-graph-api`).

### Component Specifications
- `Polling Service`: Periodically fetches emails from MS Graph. (Source: `architecture/5-components.md#511-polling-service`).
- `Webhook Service`: Receives real-time email notifications from MS Graph. (Source: `architecture/5-components.md#512-webhook-service`).
- `Redis Inbound Queue`: Buffers raw email metadata. (Source: `architecture/5-components.md#513-redis-inbound-queue`).

### File Locations
- `concurrent_storage/redis_manager.py`: Centralized Redis interaction logic (queues, session, rate limiting). (Source: `architecture/10-source-tree.md`).
- `core/polling_service.py`: Needs integration of rate limiting. (Source: `architecture/10-source-tree.md`).
- `core/webhook_service.py`: Needs integration of rate limiting. (Source: `architecture/10-source-tree.md`).
- `utils/config.py`: Centralized application configuration; for configurable rate limit threshold and time window. (Source: `architecture/10-source-tree.md`).

### Testing Requirements
- Unit tests using `pytest` and `unittest.mock`. (Source: `architecture/14-test-strategy-and-standards.md#1421-unit-tests`).
- Coverage >90%. (Source: `architecture/14-test-strategy-and-standards.md#1421-unit-tests`).
- Generate tests for all public methods and functions. Cover edge cases, boundary conditions, and expected error scenarios. Follow AAA pattern. Mock all external dependencies. (Source: `architecture/14-test-strategy-and-standards.md#1421-unit-tests`).

### Technical Constraints
- All configurable parameters must be loaded from `utils/config.py` or environment variables. (Source: `architecture/13-coding-standards.md#133-critical-rules`).
- All interactions with Redis must be encapsulated within `concurrent_storage/redis_manager.py`. (Source: `architecture/13-coding-standards.md#133-critical-rules`).
- All outbound HTTP calls to external APIs must use `httpx`. (Source: `architecture/13-coding-standards.md#133-critical-rules`).

### Testing
- Test file location: `tests/unit/` directory, mirroring the source code structure (e.g., `tests/unit/core/test_batch_processor.py`). (Source: `architecture/14-test-strategy-and-standards.md#1421-unit-tests`)
- Test standards: Follow the AAA (Arrange, Act, Assert) pattern for clarity. (Source: `architecture/14-test-strategy-and-standards.md#1421-unit-tests`)
- Testing frameworks and patterns to use: `pytest` for unit tests, `unittest.mock` for mocking. (Source: `architecture/14-test-strategy-and-standards.md#1421-unit-tests`)
- Any specific testing requirements for this story: Unit tests verify that the rate limiter correctly blocks requests when the configured threshold is surpassed. (Source: Acceptance Criteria 4)

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-10-31 | 1.0 | Initial draft of Story 2.1 | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
### Debug Log References
### Completion Notes List
### File List

## QA Results
