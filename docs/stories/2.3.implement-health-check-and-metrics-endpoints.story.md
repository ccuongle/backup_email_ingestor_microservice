# Story 2.3: Implement Health Check and Metrics Endpoints

## Status
Pass

## Story
**As an** operator,
**I want** basic health check and metrics endpoints,
**so that** the service's health and performance can be monitored by an external tool.

## Acceptance Criteria
1.  A `/health` endpoint is added to the main FastAPI application that returns a `200 OK` status if the service is running and can connect to Redis.
2.  A `/metrics` endpoint is added that exposes key application metrics in a simple JSON format (e.g., `{"emails_processed": 123, "emails_failed": 4, "current_queue_size": 56}`).
3.  The metrics should be sourced from the `RedisStorageManager`'s metrics and counter functions.
4.  The new endpoints are excluded from any authentication requirements.

## Tasks / Subtasks
- [x] **AC: 1, 4** - Implement the `/health` endpoint.
  - [x] In `concurrent_storage/redis_manager.py`, add a new `async` function `check_redis_connection` that executes a `PING` command to verify connectivity.
  - [x] In `api/ms1_apiHanlder.py`, create a new `async` GET endpoint at `/health`.
  - [x] The endpoint should call `check_redis_connection` and return a `200 OK` response if successful, or a `503 Service Unavailable` if it fails.
  - [x] Ensure the endpoint does not require authentication.
- [x] **AC: 2, 3, 4** - Implement the `/metrics` endpoint.
  - [x] In `concurrent_storage/redis_manager.py`, implement `async` functions to retrieve:
    - Total processed emails count (e.g., `get_total_emails_processed`).
    - Total failed emails count (e.g., `get_total_emails_failed`).
    - Current inbound queue size (e.g., `get_inbound_queue_size`).
  - [x] In `api/ms1_apiHanlder.py`, create a new `async` GET endpoint at `/metrics`.
  - [x] The endpoint should call the new functions in `redis_manager` and return a JSON response with the metrics.
  - [x] Ensure the endpoint does not require authentication.
- [x] **AC: 1, 2** - Create unit tests for the new endpoints.
  - [x] Create a new test file `tests/unit/api/test_ms1_api_handler.py`.
  - [x] Write unit tests for the `/health` endpoint, using `unittest.mock.patch` to simulate both successful and failed Redis connections.
  - [x] Write unit tests for the `/metrics` endpoint, using `unittest.mock.patch` to simulate the `redis_manager` functions returning sample data and assert the structure and content of the JSON response.

## Dev Notes
### API Specifications
- New endpoints will be added to the FastAPI application. [Source: `architecture/8-rest-api-spec.md`]
- `/health` (GET): Returns `200 OK` or `503 Service Unavailable`.
- `/metrics` (GET): Returns a JSON object with application metrics. This replaces the session-specific `/metrics` endpoint noted in the current OpenAPI spec.

### Data Models
- No new data models are introduced. Metrics are derived from existing Redis data structures. [Source: `architecture/4-data-models.md`]
- Metrics will be sourced from Redis counters and queue lengths. [Source: `architecture/9-database-schema.md#9.6-rate-limiting-counters`, `architecture/9-database-schema.md#9.2-redis-inbound-queue`]

### File Locations
- Endpoint Implementation: `api/ms1_apiHanlder.py`. [Source: `architecture/10-source-tree.md`]
- Redis Logic: `concurrent_storage/redis_manager.py`. [Source: `architecture/10-source-tree.md`]
- Unit Tests: `tests/unit/api/test_ms1_api_handler.py`. [Source: `architecture/10-source-tree.md`, `architecture/14-test-strategy-and-standards.md#14.2.1-unit-tests`]

### Technical Constraints
- All Redis interactions MUST be performed via the `concurrent_storage/redis_manager.py` module. [Source: `architecture/13-coding-standards.md#13.3-critical-rules`]
- All new I/O-bound functions (API endpoints, Redis calls) MUST be `async`. [Source: `architecture/13-coding-standards.md#13.4.1-python-specifics`]

### Testing Requirements
- Unit tests must be created following the AAA (Arrange, Act, Assert) pattern. [Source: `architecture/14-test-strategy-and-standards.md#14.2.1-unit-tests`]
- External dependencies (like the Redis manager) must be mocked in unit tests. [Source: `architecture/14-test-strategy-and-standards.md#14.2.1-unit-tests`]

## Dev Agent Record

### File List

- `concurrent_storage/redis_manager.py`
- `api/ms1_apiHanlder.py`
- `tests/unit/api/test_ms1_api_handler.py`

## QA Results

### Review Date: 2025-11-03

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation is correct and follows the requirements. The code is well-structured and tested.

### Refactoring Performed

No refactoring was performed.

### Compliance Check

- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓]
- All ACs Met: [✓]

### Improvements Checklist

- [ ] Consider adding more metrics to the /metrics endpoint.

### Security Review

The new endpoints are not protected by authentication, as per requirements.

### Performance Considerations

The new endpoints are simple and should not have a significant performance impact.

### Files Modified During Review

None.

### Gate Status

Gate: PASS → qa/gates/2.3.implement-health-check-and-metrics-endpoints.yml

### Recommended Status

[✓ Ready for Done]
