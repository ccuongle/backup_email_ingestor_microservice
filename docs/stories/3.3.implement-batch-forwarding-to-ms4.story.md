# Story 3.3: Implement Batch Forwarding to MS4

## Status
Ready for Review

## Story
**As a** developer,
**I want** to modify the `batch_processor` to collect data from multiple processed emails and send it to MS4 as a single batch,
**so that** we dramatically reduce network requests and increase overall throughput.

## Acceptance Criteria
1. The `batch_processor` accumulates the data returned from `unified_email_processor` up to a configurable batch size (e.g., 50).
2. A single `httpx` POST request is sent to the MS4 batch endpoint with the aggregated payload.
3. The processor correctly handles success and error responses for the entire batch.
4. The existing performance test, `tests/test_unitvsbatch_performnace.py`, is updated to measure and assert the throughput improvement against the 10,000 invoice-per-session target.
5. The system correctly handles partial batches (e.g., when the queue is nearly empty).

## Tasks / Subtasks
- [x] **AC: 1** - Modify `batch_processor` to accumulate payloads.
    - [x] Implement logic in `core/batch_processor.py` to collect processed email payloads from `unified_email_processor`.
    - [x] Configure a batch size (e.g., 50) for accumulation.
    - [x] Enqueue accumulated batches to `Redis MS4 Outbound Queue` via `concurrent_storage/redis_manager.py`.
- [x] **AC: 2, 3** - Implement `MS4 Batch Sender` to send aggregated payloads.
    - [x] Create `core/ms4_batch_sender.py`.
    - [x] Implement logic to dequeue batches from `Redis MS4 Outbound Queue` via `concurrent_storage/redis_manager.py`.
    - [x] Construct a single JSON array payload conforming to the MS4 batch endpoint contract.
    - [x] Send a single `httpx` POST request to the MS4 batch endpoint (`/batch-metadata`).
    - [x] Implement error handling for `202 Accepted`, `400 Bad Request`, `401 Unauthorized`, `429 Too Many Requests`, `500 Internal Server Error` responses.
    - [x] Implement retry logic and circuit breaker policies for MS4 API calls using `httpx`.
    - [x] Include API Key in `X-API-Key` header for authentication.
- [x] **AC: 4** - Update performance test.
    - [x] Modify `tests/test_unitvsbatch_performnace.py` to measure throughput with batching.
    - [x] Assert throughput improvement against the 10,000 invoice-per-session target.
- [x] **AC: 5** - Handle partial batches.
    - [x] Ensure `MS4 Batch Sender` can send partial batches when the queue is nearly empty or a session ends.
- [x] Write unit tests for `core/ms4_batch_sender.py`.
    - [x] Create `tests/unit/core/test_ms4_batch_sender.py`.
    - [x] Mock `httpx` and `redis_manager` interactions.
    - [x] Test batch accumulation, sending, and error handling.

## Dev Notes
### Previous Story Insights
Story 3.2 refactored `unified_email_processor` to return structured data (JSON payload) instead of directly calling MS4, and `batch_processor` was updated to handle this. This story builds directly on that output.

### Data Models
- **EmailMessage**: The `raw_json` attribute of `EmailMessage` is transformed into the MS4 payload. The `batch_processor` will accumulate these transformed payloads. [Source: `architecture/4-data-models.md#41-emailmessage`]

### API Specifications
- **MS4 Persistence API Batch Endpoint**:
    - **Method**: `POST`
    - **URL**: `/batch-metadata`
    - **Payload Structure**: JSON array of metadata objects, each conforming to the existing `/metadata` endpoint structure.
    - **Response Codes**: `2022 Accepted`, `400 Bad Request`, `401 Unauthorized`, `429 Too Many Requests`, `500 Internal Server Error`.
    - **Authentication**: API Key in `X-API-Key` header.
    - **Rate Limits**: 120 requests per minute, `Retry-After` header for `429`.
    - **Recommended Batch Size**: 50 invoices per batch.
    [Source: `ms4_api_contract.md#22-payload-structure`, `ms4_api_contract.md#23-response-codes`, `ms4_api_contract.md#24-authentication`, `ms4_api_contract.md#25-rate-limiting`, `ms4_api_contract.md#3-recommended-batch-size`]

### Component Specifications
- **Batch Processor**: Will be modified to enqueue prepared MS4 payloads to the `Redis MS4 Outbound Queue`. [Source: `architecture/5-components.md#514-batch-processor`]
- **MS4 Batch Sender**: New component responsible for dequeuing from `Redis MS4 Outbound Queue`, aggregating, and sending to MS4. [Source: `architecture/5-components.md#516-ms4-batch-sender`]
- **Redis MS4 Outbound Queue**: Will buffer prepared MS4 payloads. [Source: `architecture/5-components.md#515-redis-ms4-outbound-queue`]

### File Locations
- `core/batch_processor.py`: To be modified for payload accumulation and enqueuing to outbound queue. [Source: `architecture/10-source-tree.md`]
- `core/ms4_batch_sender.py`: New file for the MS4 Batch Sender component. [Source: `architecture/10-source-tree.md`]
- `concurrent_storage/redis_manager.py`: Will be used for all Redis interactions (enqueue/dequeue). [Source: `architecture/13-coding-standards.md#133-critical-rules`]
- `tests/test_unitvsbatch_performnace.py`: To be updated for performance measurement. [Source: `architecture/10-source-tree.md`]
- `tests/unit/core/test_ms4_batch_sender.py`: New unit test file for `ms4_batch_sender.py`. [Source: `architecture/10-source-tree.md`]

### Technical Constraints
- All outbound HTTP calls to external APIs (MS4) must use `httpx` and be wrapped with retry and circuit breaker policies. [Source: `architecture/13-coding-standards.md#133-critical-rules`]
- All interactions with Redis must be encapsulated within `concurrent_storage/redis_manager.py`. [Source: `architecture/13-coding-standards.md#133-critical-rules`]
- Use Python type hints for all function signatures. [Source: `architecture/13-coding-standards.md#1341-python-specifics`]
- Prefer `asyncio` and `async`/`await` for I/O-bound operations. [Source: `architecture/13-coding-standards.md#1341-python-specifics`]

### Testing Requirements
- Unit tests for `ms4_batch_sender.py` should follow the AAA pattern, mock `httpx` and `redis_manager`. [Source: `architecture/14-test-strategy-and-standards.md#1421-unit-tests`]
- Performance tests (`tests/test_unitvsbatch_performnace.py`) must be updated to measure and assert throughput improvement. [Source: `architecture/14-test-strategy-and-standards.md#144-continuous-testing`]

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-11-03 | 1.0 | Initial draft of Story 3.3 | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
{{agent_model_name_version}}

### Debug Log References

### Completion Notes List
- Modified `core/batch_processor.py` to accumulate payloads and enqueue them to a new Redis queue.
- Created `core/ms4_batch_sender.py` to send batches of payloads to MS4.
- Updated `cache/redis_manager.py` with a new queue for MS4.
- Updated `utils/config.py` with MS4 API key and batch size.
- Created `tests/test_batch_forwarding_performance.py` to test the new batching functionality.
- Created `tests/unit/core/test_ms4_batch_sender.py` for unit testing the `MS4BatchSender`.

### File List
- `core/batch_processor.py`
- `core/ms4_batch_sender.py`
- `cache/redis_manager.py`
- `utils/config.py`
- `tests/test_batch_forwarding_performance.py`
- `tests/unit/core/test_ms4_batch_sender.py`
