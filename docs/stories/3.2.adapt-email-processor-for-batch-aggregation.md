# Story 3.2: Adapt Email Processor for Batch Aggregation

## Status
Pass

## Story
**As a** developer,
**I want** to refactor the `unified_email_processor` so that it returns structured data instead of directly calling the MS4 service,
**so that** its output can be aggregated for batch processing.

## Acceptance Criteria
1. The `unified_email_processor` is modified to no longer make a direct `httpx` call to MS4.
2. The processor's primary function now returns the JSON payload that was previously sent to MS4.
3. The `batch_processor` is updated to handle this new return value without breaking the existing (non-batch) workflow.
4. All unit tests for the `unified_email_processor` are updated to reflect the new return signature and behavior.

## Tasks / Subtasks
- [x] **AC: 1, 2** - Refactor `unified_email_processor` to return JSON payload.
    - [x] Modify the main function in `core/unified_email_processor.py` to return the generated JSON payload.
    - [x] Remove the `httpx` call to the MS4 service from `core/unified_email_processor.py`.
- [x] **AC: 3** - Update `batch_processor` to handle the new return value.
    - [x] Modify `core/batch_processor.py` to accept the JSON payload from `unified_email_processor`.
    - [x] Ensure the existing workflow in `core/batch_processor.py` continues to function.
- [x] **AC: 4** - Update unit tests for `unified_email_processor`.
    - [x] Modify `tests/unit/core/test_unified_email_processor.py` to assert the returned JSON payload.
    - [x] Remove any mocks related to the `httpx` call to MS4.

## Dev Notes
### Previous Story Insights
Story 3.1 defined the MS4 batch endpoint contract in `docs/ms4_api_contract.md`. This is the target for the batch processing that this story enables.

### Data Models
- **EmailMessage**: The primary entity processed by `unified_email_processor`. The `raw_json` attribute is used to generate the MS4 payload. [Source: `docs/architecture/4-data-models.md`]

### API Specifications
- This story removes a direct API call. The returned JSON payload should conform to the contract for the (now removed) single-item endpoint, which will be used to build the batch payload in a later story.

### File Locations
- `core/unified_email_processor.py`: To be modified to return JSON. [Source: `docs/architecture/10-source-tree.md`]
- `core/batch_processor.py`: To be modified to handle the new return value. [Source: `docs/architecture/10-source-tree.md`]
- `tests/unit/core/test_unified_email_processor.py`: To be updated to reflect the changes in `unified_email_processor`. [Source: `docs/architecture/10-source-tree.md`]

### Technical Constraints
- All outbound HTTP calls to external APIs (including MS4) must use the `httpx` library and be wrapped with defined retry and circuit breaker policies. While this story removes a call, the principle remains for future stories. [Source: `docs/architecture/13-coding-standards.md`]
- All interactions with Redis must be encapsulated within and routed through `concurrent_storage/redis_manager.py`. [Source: `docs/architecture/13-coding-standards.md`]

### Testing
- Unit tests should follow the AAA (Arrange, Act, Assert) pattern. [Source: `docs/architecture/14-test-strategy-and-standards.md#14.2.1-unit-tests`]
- External dependencies (like external APIs) must be mocked in unit tests. This will now apply to the `batch_processor`'s interaction with the `unified_email_processor`. [Source: `docs/architecture/14-test-strategy-and-standards.md#14.2.1-unit-tests`]

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-11-03 | 1.0 | Initial draft of Story 3.2 | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List
- `core/unified_email_processor.py`
- `core/batch_processor.py`
- `tests/unit/core/test_unit_unified_email_processor.py`

## QA Results

### Review Date: 2025-11-03

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation is of high quality. The code is clean, well-structured, and easy to understand. The refactoring of the `unified_email_processor` to return a payload instead of making a direct API call is a good design choice that improves the component's testability and reusability.

### Refactoring Performed

No refactoring was performed during this review as the code was already in good shape.

### Compliance Check

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓
- All ACs Met: ✓

### Improvements Checklist

- [x] All required changes have been implemented and tested.

### Security Review

No security concerns were found.

### Performance Considerations

No performance issues were found.

### Files Modified During Review

None.

### Gate Status

Gate: PASS → docs/qa/gates/3.2-adapt-email-processor-for-batch-aggregation.yml

### Recommended Status

✓ Ready for Done
